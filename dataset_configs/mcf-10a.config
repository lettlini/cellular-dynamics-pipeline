includeConfig 'common.config'

params {
    in_dir = "monolayer/juergen/"
    out_dir = "juergen"
    min_nucleus_area_mumsq = 50
    cell_cutoff_mum = 20
    lag_times_minutes = "30,60,90,120,150,180,210,240"
    minimum_neighbors = 2
    exclude_attrs = "cell_Q_tensor,nucleus_Q_tensor"
    include_attrs = ""
}

profiles {
    cluster {
        process {
            time = { 6.hour * 2 * task.attempt }
            memory = { 50.GB * 2 * task.attempt }
            cpus = 12

            errorStrategy = 'retry'
            maxRetries = 3

            // CPU Requirements
            withLabel: high_cpu {
                cpus = 42
            }
            withLabel: low_cpu {
                cpus = 2
            }
            withLabel: single_threaded {
                cpus = 1
            }
            // Time Requirements
            withLabel: short_running {
                time = { 1.hour * 2 * task.attempt }
            }
            withLabel: long_running {
                time = { 14.hour * 2 * task.attempt }
            }
            // Memory Requirements
            withLabel: high_memory {
                memory = { 64.GB * 2 * task.attempt }
            }

            withName: nuclei_segmentation {
                cpus = 16
            }
        }
    }

    local {
        process {
            executor = 'SLURM'
            queue = "LocalQ"

            cpus = 4
            errorStrategy = "retry"
            maxRetries = 3

            memory = { task.attempt * 1.5 * 26.GB }
            // Double memory each retry

            // High CPU processes
            withLabel: high_cpu {
                cpus = 12
            }

            withLabel: low_cpu {
                cpus = 2
            }

            withLabel: single_threaded {
                cpus = 1
            }

            withLabel: high_memory {
                memory = { task.attempt * 1.5 * 64.GB }
            }

            withLabel: io {
                memory = "30GB"
                cpus = 2
            }

            withName: nuclei_segmentation_cellpose {
                maxForks = 2
            }
        }
    }
}
